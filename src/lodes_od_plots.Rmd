---
title: "Lodes OD Plots"
author: "Owen Hart"
date: "7/15/2020"
output: html_document
---

```{r}
library(R.utils)
library(data.table)
library(tidyr)
library(dplyr)
library(readr)
library(ggplot2)
library(sf)
library(leaflet)
library(mapview)
library(reshape2)
library(raster)
library(tigris)
```

```{r}
lodes17 <- read_csv("../data/lodes/agg/jobs_all_2017.csv")
lodes16 <- read_csv("../data/lodes/agg/jobs_all_2016.csv")
lodes15 <- read_csv("../data/lodes/agg/jobs_all_2015.csv")

lodes17$h_state <- substr(lodes17$h_geocode_tract, 1, 2)
lodes17$h_county <- substr(lodes17$h_geocode_tract, 3, 5)
lodes17$h_tract <- substr(lodes17$h_geocode_tract, 6, 11)

lodes16$h_state <- substr(lodes16$h_geocode_tract, 1, 2)
lodes16$h_county <- substr(lodes16$h_geocode_tract, 3, 5)
lodes16$h_tract <- substr(lodes16$h_geocode_tract, 6, 11)

lodes15$h_state <- substr(lodes15$h_geocode_tract, 1, 2)
lodes15$h_county <- substr(lodes15$h_geocode_tract, 3, 5)
lodes15$h_tract <- substr(lodes15$h_geocode_tract, 6, 11)

#now work geoid
lodes17$w_state <- substr(lodes17$w_geocode_tract, 1, 2)
lodes17$w_county <- substr(lodes17$w_geocode_tract, 3, 5)
lodes17$w_tract <- substr(lodes17$w_geocode_tract, 6, 11)

lodes16$w_state <- substr(lodes16$w_geocode_tract, 1, 2)
lodes16$w_county <- substr(lodes16$w_geocode_tract, 3, 5)
lodes16$w_tract <- substr(lodes16$w_geocode_tract, 6, 11)

lodes15$w_state <- substr(lodes15$w_geocode_tract, 1, 2)
lodes15$w_county <- substr(lodes15$w_geocode_tract, 3, 5)
lodes15$w_tract <- substr(lodes15$w_geocode_tract, 6, 11)
```

Must load in Oregon XWalk csv
```{r}
#download.file(
#  url = "https://lehd.ces.census.gov/data/lodes/LODES7/or/or_xwalk.csv.gz", 
#  destfile = "../data/lodes/or_xwalk.csv.gz")
#gunzip("../data/lodes/or_xwalk.csv.gz")
or_xw <- read_csv("../data/lodes/or_xwalk.csv", col_types = cols(cty = col_character()))
or_xw <- or_xw %>% filter(st == 41)
```
What % of jobs flow from outside of Fairfax County?
```{r}
bool_cond17 <-lodes17$h_county != "065" & (lodes17$w_county == "065" & lodes17$w_state == "41")
bool_cond16 <-lodes16$h_county != "065" & (lodes16$w_county == "065" & lodes16$w_state == "41")
bool_cond15 <-lodes15$h_county != "065" & (lodes15$w_county == "065" & lodes15$w_state == "41")
flows_in_17 <-lodes17[bool_cond17, ]
flows_in_16 <-lodes16[bool_cond16, ]
flows_in_15 <-lodes15[bool_cond15, ]
```

Of the flows into Wasco County from outside, what percent are from other counties in Oregon?
```{r}
#2017
perc_flows_othercnt_2017 <- mean(flows_in_17$h_state == "41") *100
agg_cnty_OR_2017 <- flows_in_17[flows_in_17$h_state == "41", ] %>%
  group_by(h_county) %>%
  summarise(S000 = sum(S000))
#Use OR crosswalk to get county names
or_xw$h_county <- substring(or_xw$cty, 3, 6)
essential <- or_xw %>%
  select(h_county, ctyname)
agg_cnty_OR_with_names_2017 <- inner_join(x = agg_cnty_OR_2017, y = unique(essential), by = "h_county")

trimmed_2017 <- agg_cnty_OR_with_names_2017[order(-agg_cnty_OR_with_names_2017$S000), ][1:10, ]
trimmed_2017 %>%
  mutate(ctyname = fct_reorder(ctyname, S000)) %>%
  ggplot(aes(S000, ctyname)) +
  geom_bar(stat="identity", fill= "dark blue", alpha=.7) +
  ggtitle("Number of Jobs flowing into Wasco County\n from other counties in Oregon (2017)") +
  xlab("Number of Jobs") + 
  ylab("County Name")
ggsave(path = "../output/lodes_maps/flows/in_flows", device = "png", filename = "in_county_flows_2017.png", plot = last_plot())

#2016
perc_flows_othercnt_2016 <- mean(flows_in_16$h_state == "41") *100
agg_cnty_OR_2016 <- flows_in_16[flows_in_16$h_state == "41", ] %>%
  group_by(h_county) %>%
  summarise(S000 = sum(S000))
agg_cnty_OR_with_names_2016 <- inner_join(x = agg_cnty_OR_2016, y = unique(essential), by = "h_county")
trimmed_2016 <- agg_cnty_OR_with_names_2016[order(-agg_cnty_OR_with_names_2016$S000), ][1:10, ]
trimmed_2016 %>%
  mutate(ctyname = fct_reorder(ctyname, S000)) %>%
  ggplot(aes(S000, ctyname)) +
  geom_bar(stat="identity", fill= "dark blue", alpha=.7) +
  ggtitle("Number of Jobs flowing into Wasco County\n from other counties in Oregon (2016)") +
  xlab("Number of Jobs") + 
  ylab("County Name")
ggsave(path = "../output/lodes_maps/flows/in_flows", device = "png", filename = "in_county_flows_2016.png", plot = last_plot())


#2015
perc_flows_othercnt_2015 <- mean(flows_in_15$h_state == "41") *100
agg_cnty_OR_2015 <- flows_in_15[flows_in_15$h_state == "41", ] %>%
  group_by(h_county) %>%
  summarise(S000 = sum(S000))
agg_cnty_OR_with_names_2015 <- inner_join(x = agg_cnty_OR_2015, y = unique(essential), by = "h_county")
trimmed_2015 <- agg_cnty_OR_with_names_2015[order(-agg_cnty_OR_with_names_2015$S000), ][1:10, ]
trimmed_2015 %>%
  mutate(ctyname = fct_reorder(ctyname, S000)) %>%
  ggplot(aes(S000, ctyname)) +
  geom_bar(stat="identity", fill= "dark blue", alpha=.7) +
  ggtitle("Number of Jobs flowing into Wasco County\n from other counties in Oregon (2015)") +
  xlab("Number of Jobs") + 
  ylab("County Name")
ggsave(path = "../output/lodes_maps/flows/in_flows", device = "png", filename = "in_county_flows_2015.png", plot = last_plot())

```
Aggregating by county over time (line plot)

```{r}
top_10_in_over_time <- inner_join(trimmed_2017, agg_cnty_OR_with_names_2016, by = "ctyname")
top_10_in_over_time <- top_10_in_over_time %>%
  select(h_county.x, ctyname, S000.x, S000.y)
top_10_in_over_time$'2017' <- top_10_in_over_time$S000.x
top_10_in_over_time$'2016' <- top_10_in_over_time$S000.y
top_10_in_over_time <- inner_join(top_10_in_over_time, agg_cnty_OR_with_names_2015, by = "ctyname") %>%
  select(h_county.x, ctyname, '2017', '2016', S000)
top_10_in_over_time$'2015' <- top_10_in_over_time$S000
top_10_in_over_time$h_county <- top_10_in_over_time$h_county.x
top_10_in_over_time <- top_10_in_over_time %>% select(-S000, -h_county.x)
top_10_in_over_time <- top_10_in_over_time %>% select(ctyname, '2017', '2016', '2015')
top_10_in_trans <- data.frame(t(top_10_in_over_time[, -1]))
colnames(top_10_in_trans) <- top_10_in_over_time$ctyname
top_10_in_trans$year <- c(2017, 2016, 2015) #SAVE NOW
write_csv(top_10_in_trans, "../data/app_10_inflows_wasco.csv")
#line plot for all jobs 2015-2017 by county
ggplot(top_10_in_trans, aes(x = year)) +
  ggtitle("Number of jobs flowing into Wasco County\nfrom other counties in Oregon from\n2015-2017") +
  labs(x = "Year", y = "Number of Jobs", colour = "County") + 
  geom_line(aes(y = `Hood River County, OR`, color = "Hood River County, OR")) + 
  geom_line(aes(y = `Multnomah County, OR`, color = "Multnomah County, OR")) + 
  geom_line(aes(y = `Clackamas County, OR`, color = "Clackamas County, OR")) + 
  geom_line(aes(y = `Marion County, OR`, color = "Marion County, OR")) + 
  geom_line(aes(y = `Washington County, OR`, color = "Washington County, OR")) + 
  geom_line(aes(y = `Deschutes County, OR`, color = "Deschutes County, OR")) + 
  geom_line(aes(y = `Jefferson County, OR`, color = "Jefferson County, OR")) + 
  geom_line(aes(y = `Lane County, OR`, color = "Lane County, OR")) + 
  geom_line(aes(y = `Umatilla County, OR`, color = "Umatilla County, OR")) + 
  geom_line(aes(y = `Sherman County, OR`, color = "Sherman County, OR"))
ggsave(path = "../output/lodes_maps/flows/in_flows", device = "png", filename = "in_county_flows_all_years.png", plot = last_plot())
```

Outflows (those who live in wasco county but do not work there, open to other states)
```{r}
bool_cond17 <- lodes17$h_county == "065" & lodes17$w_county != "065"
bool_cond16 <- lodes16$h_county == "065" & lodes16$w_county != "065"
bool_cond15 <- lodes15$h_county == "065" & lodes15$w_county != "065"

flows_out_17 <-lodes17[bool_cond17, ]
flows_out_16 <-lodes16[bool_cond16, ]
flows_out_15 <-lodes15[bool_cond15, ]
```

Most popular counties that those who live in Wasco County but not work in, go to work
```{r}
out_agg_2017 <- flows_out_17 %>%
  group_by(w_county) %>%
  summarise(S000 = sum(S000))
or_xw$w_county <- substring(or_xw$cty, 3, 6)
essential <- or_xw %>%
  select(w_county, ctyname)
agg_out_names_2017 <- inner_join(x = out_agg_2017, y = unique(essential), by = "w_county")
trimmed_out_2017 <- agg_out_names_2017[order(-agg_out_names_2017$S000), ][1:10, ]
trimmed_out_2017 %>%
  mutate(ctyname = fct_reorder(ctyname, S000)) %>%
  ggplot(aes(S000, ctyname)) +
  geom_bar(stat="identity", fill= "red", alpha=.3) +
  ggtitle("Number of Jobs flowing out of Wasco County\n to other counties in Oregon (2017)") +
  xlab("Number of Jobs") + 
  ylab("County Name")
ggsave(path = "../output/lodes_maps/flows/out_flows", device = "png", filename = "out_county_flows_2017.png", plot = last_plot())

out_agg_2016 <- flows_out_16 %>%
  group_by(w_county) %>%
  summarise(S000 = sum(S000))
agg_out_names_2016 <- inner_join(x = out_agg_2016, y = unique(essential), by = "w_county")
trimmed_out_2016 <- agg_out_names_2016[order(-agg_out_names_2016$S000), ][1:10, ]
trimmed_out_2016 %>%
  mutate(ctyname = fct_reorder(ctyname, S000)) %>%
  ggplot(aes(S000, ctyname)) +
  geom_bar(stat="identity", fill= "red", alpha=.3) +
  ggtitle("Number of Jobs flowing out of Wasco County\n to other counties in Oregon (2016)") +
  xlab("Number of Jobs") + 
  ylab("County Name")
ggsave(path = "../output/lodes_maps/flows/out_flows", device = "png", filename = "out_county_flows_2016.png", plot = last_plot())

out_agg_2015 <- flows_out_15 %>%
  group_by(w_county) %>%
  summarise(S000 = sum(S000))
agg_out_names_2015 <- inner_join(x = out_agg_2015, y = unique(essential), by = "w_county")
trimmed_out_2015 <- agg_out_names_2015[order(-agg_out_names_2015$S000), ][1:10, ]
trimmed_out_2015 %>%
  mutate(ctyname = fct_reorder(ctyname, S000)) %>%
  ggplot(aes(S000, ctyname)) +
  geom_bar(stat="identity", fill= "red", alpha=.3) +
  ggtitle("Number of Jobs flowing out of Wasco County\n to other counties in Oregon (2015)") +
  xlab("Number of Jobs") + 
  ylab("County Name")
ggsave(path = "../output/lodes_maps/flows/out_flows", device = "png", filename = "out_county_flows_2015.png", plot = last_plot())
```

outflows over time!!
```{r}
top_10_out_over_time <- inner_join(trimmed_out_2017, agg_out_names_2016, by = "ctyname")
top_10_out_over_time <- top_10_out_over_time %>%
  select(w_county.x, ctyname, S000.x, S000.y)
top_10_out_over_time$'2017' <- top_10_out_over_time$S000.x
top_10_out_over_time$'2016' <- top_10_out_over_time$S000.y
top_10_out_over_time <- inner_join(top_10_out_over_time, agg_cnty_OR_with_names_2015, by = "ctyname") %>%
  select(w_county.x, ctyname, '2017', '2016', S000)
top_10_out_over_time$'2015' <- top_10_out_over_time$S000
top_10_out_over_time$h_county <- top_10_out_over_time$w_county.x
top_10_out_over_time <- top_10_out_over_time %>% select(-S000, -w_county.x)
top_10_out_over_time <- top_10_out_over_time %>% select(ctyname, '2017', '2016', '2015')
top_10_out_trans <- data.frame(t(top_10_out_over_time[, -1]))
colnames(top_10_out_trans) <- top_10_out_over_time$ctyname
top_10_out_trans$year <- c(2017, 2016, 2015)
write_csv(top_10_out_trans, "../data/app_10_outflows_wasco.csv")

#line plot for all jobs 2015-2017 by county
ggplot(top_10_out_trans, aes(x = year)) +
  ggtitle("Number of jobs flowing from Wasco County\ninto other counties in Oregon from\n2015-2017") +
  labs(x = "Year", y = "Number of Jobs", colour = "County") + 
  geom_line(aes(y = `Hood River County, OR`, color = "Hood River County, OR")) + 
  geom_line(aes(y = `Multnomah County, OR`, color = "Multnomah County, OR")) + 
  geom_line(aes(y = `Clackamas County, OR`, color = "Clackamas County, OR")) + 
  geom_line(aes(y = `Deschutes County, OR`, color = "Deschutes County, OR")) + 
  geom_line(aes(y = `Washington County, OR`, color = "Washington County, OR")) + 
  geom_line(aes(y = `Marion County, OR`, color = "Marion County, OR")) + 
  geom_line(aes(y = `Jefferson County, OR`, color = "Jefferson County, OR")) + 
  geom_line(aes(y = `Umatilla County, OR`, color = "Umatilla County, OR")) + 
  geom_line(aes(y = `Lane County, OR`, color = "Lane County, OR")) + 
  geom_line(aes(y = `Sherman County, OR`, color = "Sherman County, OR"))
ggsave(path = "../output/lodes_maps/flows/out_flows", device = "png", filename = "out_county_flows_all_years.png", plot = last_plot())
```





Mapping S. Wasco
```{r}
wasco_points <- (blocks("OR", county = "Wasco"))
wasco_lines <- data.frame(wasco_points)
south_wasco_points <- st_read("../data/shps/swsd")
```

Reading in files
```{r}
main17 <- fread("../data/lodes/or_od_main_JT00_2017.csv", 
              colClasses = c("w_geocode" = "character",
                             "h_geocode" = "character"))
aux17 <- fread("../data/lodes/or_od_aux_JT00_2017.csv", 
              colClasses = c("w_geocode" = "character",
                             "h_geocode" = "character"))
full_data17 <- rbind(main17, aux17)

main16 <- fread("../data/lodes/or_od_main_JT00_2016.csv", 
              colClasses = c("w_geocode" = "character",
                             "h_geocode" = "character"))
aux16 <- fread("../data/lodes/or_od_aux_JT00_2016.csv", 
              colClasses = c("w_geocode" = "character",
                             "h_geocode" = "character"))
full_data16 <- rbind(main16, aux16)

main15 <- fread("../data/lodes/or_od_main_JT00_2015.csv", 
              colClasses = c("w_geocode" = "character",
                             "h_geocode" = "character"))
aux15 <- fread("../data/lodes/or_od_aux_JT00_2015.csv", 
              colClasses = c("w_geocode" = "character",
                             "h_geocode" = "character"))
full_data15 <- rbind(main15, aux15)
```

Filtering so that it only includes Wasco County
```{r}
wasco17 <- full_data17 %>% 
  filter(w_geocode %in% full_data17$w_geocode[substr(full_data17$w_geocode, 1, 5) == "41065"]|h_geocode %in% full_data17$h_geocode[substr(full_data17$h_geocode, 1, 5) == "41065"])
wasco16 <- full_data16 %>% 
  filter(w_geocode %in% full_data16$w_geocode[substr(full_data16$w_geocode, 1, 5) == "41065"]|h_geocode %in% full_data16$h_geocode[substr(full_data16$h_geocode, 1, 5) == "41065"])
wasco15 <- full_data15 %>% 
  filter(w_geocode %in% full_data15$w_geocode[substr(full_data15$w_geocode, 1, 5) == "41065"]|h_geocode %in% full_data15$h_geocode[substr(full_data15$h_geocode, 1, 5) == "41065"])
```

Joining with Wasco Lines
```{r}
wascolines_17 <- inner_join(wasco17, wasco_lines, by = c("w_geocode" = "GEOID10"))
wascolines_16 <- inner_join(wasco16, wasco_lines, by = c("w_geocode" = "GEOID10"))
wascolines_15 <- inner_join(wasco15, wasco_lines, by = c("w_geocode" = "GEOID10"))
```


Grouping by work geocode (because that is going to be Wasco County)
```{r}
agg_17 <- wascolines_17 %>%
  group_by(w_geocode, INTPTLAT10, INTPTLON10, geometry) %>%
  summarise(S000 = sum(S000), 
            SA01 = sum(SA01), 
            SA02 = sum(SA02), 
            SA03 = sum(SA03), 
            SE01 = sum(SE01), 
            SE02 = sum(SE02), 
            SE03 = sum(SE03), 
            SI01 = sum(SI01), 
            SI02 = sum(SI02), 
            SI03 = sum(SI03))
write_sf(st_as_sf(agg_17), "../data/app_lodes_od_agg_2017.shp")
agg_16 <- wascolines_16 %>%
  group_by(w_geocode, INTPTLAT10, INTPTLON10, geometry) %>%
  summarise(S000 = sum(S000), 
            SA01 = sum(SA01), 
            SA02 = sum(SA02), 
            SA03 = sum(SA03), 
            SE01 = sum(SE01), 
            SE02 = sum(SE02), 
            SE03 = sum(SE03), 
            SI01 = sum(SI01), 
            SI02 = sum(SI02), 
            SI03 = sum(SI03))
write_sf(st_as_sf(agg_16), "../data/app_lodes_od_agg_2016.shp")
agg_15 <- wascolines_15 %>%
  group_by(w_geocode, INTPTLAT10, INTPTLON10, geometry) %>%
  summarise(S000 = sum(S000), 
            SA01 = sum(SA01), 
            SA02 = sum(SA02), 
            SA03 = sum(SA03), 
            SE01 = sum(SE01), 
            SE02 = sum(SE02), 
            SE03 = sum(SE03), 
            SI01 = sum(SI01), 
            SI02 = sum(SI02), 
            SI03 = sum(SI03))
write_sf(st_as_sf(agg_15), "../data/app_lodes_od_agg_2015.shp")
```

interactive maps
```{r}
qtileS000 <- colorQuantile(c('#D1E0BF', '#E57200'), agg_17$S000, 5)
agg_17 <- read_sf("../data/app_lodes_od_agg_2017.shp")
map2017leaf <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolylines(
    data = south_wasco_points,
    color = "purple",
    weight = 1,
    opacity = 1,
    group = "Basemap")

map2017leaf <- map2017leaf %>%
  addPolygons(
    data = st_as_sf(agg_17),
    weight = 1,
    opacity = 0,
    fillOpacity = 1,
    group = "All Jobs",
    fillColor = ~qtileS000(agg_17$S000),
    label = agg_17$S000)
map2017leaf <- map2017leaf %>%
      addLegend(
        data = agg_17,
        "bottomright",
        pal = qtileS000,
        values = ~ S000,
        title = "Wasco County Job Density",
        opacity = 1,
        group = "All Jobs",
        na.label = "NA")

#SI01
map2017leaf <- map2017leaf %>%
  addPolygons(
    data = st_as_sf(agg_17),
    weight = 1,
    opacity = 0,
    fillOpacity = 1,
    group = "Goods Producing Sector",
    fillColor = ~qtileS000(agg_17$SI01),
    label = agg_17$SI01) %>%
  addLegend(
    data = agg_17,
    "bottomright",
    pal = qtileS000,
    values = ~ SI01,
    title = "Wasco County Job Density",
    opacity = 1,
    group = "Goods Producing Sector",
    na.label = "NA")

#SI02
map2017leaf <- map2017leaf %>%
  addPolygons(
    data = st_as_sf(agg_17),
    weight = 1,
    opacity = 0,
    fillOpacity = 1,
    group = "Trade, Transportation,and Utilities Sector",
    fillColor = ~qtileS000(agg_17$SI02),
    label = agg_17$SI02) %>%
  addLegend(
    data = agg_17,
    "bottomright",
    pal = qtileS000,
    values = ~ SI02,
    title = "Wasco County Job Density",
    opacity = 1,
    group = "Trade, Transportation,and Utilities Sector",
    na.label = "NA")

#SI03
map2017leaf <- map2017leaf %>%
  addPolygons(
    data = st_as_sf(agg_17),
    weight = 1,
    opacity = 0,
    fillOpacity = 1,
    group = "All Other Services Sector",
    fillColor = ~qtileS000(agg_17$SI03),
    label = agg_17$SI03) %>%
  addLegend(
    data = agg_17,
    "bottomright",
    pal = qtileS000,
    values = ~ SI03,
    title = "Wasco County Job Density",
    opacity = 1,
    group = "All Other Services Sector",
    na.label = "NA")

map2017leaf <- map2017leaf %>%
      addLayersControl(
        baseGroups = c("South Wasco School District"),
        overlayGroups = c("All Jobs", "Goods Producing Sector", "Trade, Transportation,and Utilities Sector", "All Other Services Sector"),
        options = layersControlOptions(collapsed = FALSE)) %>%
  hideGroup(c("Goods Producing Sector", "Trade, Transportation,and Utilities Sector", "All Other Services Sector"))
```


2016
```{r}
map2016leaf <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolylines(
    data = south_wasco_points,
    color = "purple",
    weight = 1,
    opacity = 1,
    group = "Basemap")
map2016leaf <- map2016leaf %>%
  addPolygons(
    data = st_as_sf(agg_16),
    weight = 1,
    opacity = 0,
    fillOpacity = 1,
    group = "All Jobs",
    fillColor = ~qtileS000(agg_16$S000),
    label = agg_16$S000)
map2016leaf <- map2016leaf %>%
      addLegend(
        data = agg_16,
        "bottomright",
        pal = qtileS000,
        values = ~ S000,
        title = "Wasco County Job Density",
        opacity = 1,
        group = "All Jobs",
        na.label = "NA")

#SI01
map2016leaf <- map2016leaf %>%
  addPolygons(
    data = st_as_sf(agg_16),
    weight = 1,
    opacity = 0,
    fillOpacity = 1,
    group = "Goods Producing Sector",
    fillColor = ~qtileS000(agg_16$SI01),
    label = agg_16$SI01) %>%
  addLegend(
    data = agg_16,
    "bottomright",
    pal = qtileS000,
    values = ~ SI01,
    title = "Wasco County Job Density",
    opacity = 1,
    group = "Goods Producing Sector",
    na.label = "NA")

#SI02
map2016leaf <- map2016leaf %>%
  addPolygons(
    data = st_as_sf(agg_16),
    weight = 1,
    opacity = 0,
    fillOpacity = 1,
    group = "Trade, Transportation,and Utilities Sector",
    fillColor = ~qtileS000(agg_16$SI02),
    label = agg_16$SI02) %>%
  addLegend(
    data = agg_16,
    "bottomright",
    pal = qtileS000,
    values = ~ SI02,
    title = "Wasco County Job Density",
    opacity = 1,
    group = "Trade, Transportation,and Utilities Sector",
    na.label = "NA")

#SI03
map2016leaf <- map2016leaf %>%
  addPolygons(
    data = st_as_sf(agg_16),
    weight = 1,
    opacity = 0,
    fillOpacity = 1,
    group = "All Other Services Sector",
    fillColor = ~qtileS000(agg_16$SI03),
    label = agg_16$SI03) %>%
  addLegend(
    data = agg_16,
    "bottomright",
    pal = qtileS000,
    values = ~ SI03,
    title = "Wasco County Job Density",
    opacity = 1,
    group = "All Other Services Sector",
    na.label = "NA")

map2016leaf <- map2016leaf %>%
      addLayersControl(
        baseGroups = c("South Wasco School District"),
        overlayGroups = c("All Jobs", "Goods Producing Sector", "Trade, Transportation,and Utilities Sector", "All Other Services Sector"),
        options = layersControlOptions(collapsed = FALSE)) %>%
  hideGroup(c("Goods Producing Sector", "Trade, Transportation,and Utilities Sector", "All Other Services Sector"))
```

2015
```{r}
map2015leaf <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolylines(
    data = south_wasco_points,
    color = "purple",
    weight = 1,
    opacity = 1,
    group = "Basemap")

map2015leaf <- map2015leaf %>%
  addPolygons(
    data = st_as_sf(agg_15),
    weight = 1,
    opacity = 0,
    fillOpacity = 1,
    group = "All Jobs",
    fillColor = ~qtileS000(agg_15$S000),
    label = agg_15$S000)
map2015leaf <- map2015leaf %>%
      addLegend(
        data = agg_15,
        "bottomright",
        pal = qtileS000,
        values = ~ S000,
        title = "Wasco County Job Density",
        opacity = 1,
        group = "All Jobs",
        na.label = "NA")

#SI01
map2015leaf <- map2015leaf %>%
  addPolygons(
    data = st_as_sf(agg_15),
    weight = 1,
    opacity = 0,
    fillOpacity = 1,
    group = "Goods Producing Sector",
    fillColor = ~qtileS000(agg_15$SI01),
    label = agg_15$SI01) %>%
  addLegend(
    data = agg_15,
    "bottomright",
    pal = qtileS000,
    values = ~ SI01,
    title = "Wasco County Job Density",
    opacity = 1,
    group = "Goods Producing Sector",
    na.label = "NA")

#SI02
map2015leaf <- map2015leaf %>%
  addPolygons(
    data = st_as_sf(agg_15),
    weight = 1,
    opacity = 0,
    fillOpacity = 1,
    group = "Trade, Transportation,and Utilities Sector",
    fillColor = ~qtileS000(agg_15$SI02),
    label = agg_15$SI02) %>%
  addLegend(
    data = agg_15,
    "bottomright",
    pal = qtileS000,
    values = ~ SI02,
    title = "Wasco County Job Density",
    opacity = 1,
    group = "Trade, Transportation,and Utilities Sector",
    na.label = "NA")

#SI03
map2015leaf <- map2015leaf %>%
  addPolygons(
    data = st_as_sf(agg_15),
    weight = 1,
    opacity = 0,
    fillOpacity = 1,
    group = "All Other Services Sector",
    fillColor = ~qtileS000(agg_15$SI03),
    label = agg_15$SI03) %>%
  addLegend(
    data = agg_15,
    "bottomright",
    pal = qtileS000,
    values = ~ SI03,
    title = "Wasco County Job Density",
    opacity = 1,
    group = "All Other Services Sector",
    na.label = "NA")

map2015leaf <- map2015leaf %>%
      addLayersControl(
        baseGroups = c("South Wasco School District"),
        overlayGroups = c("All Jobs", "Goods Producing Sector", "Trade, Transportation,and Utilities Sector", "All Other Services Sector"),
        options = layersControlOptions(collapsed = FALSE)) %>%
  hideGroup(c("Goods Producing Sector", "Trade, Transportation,and Utilities Sector", "All Other Services Sector"))
```

Showing all maps
```{r}
map2017leaf
map2016leaf
map2015leaf
```




Aaron's script
... try using stars
```{r}
crop_mask_raster_to_spatial <- function(raster_obj, sf_obj) {
  library(raster)
  library(sf)
  library(data.table)
  for (i in 1:nrow(sf_obj)) {
    sf_row <- sf_obj[i,]
    sp_row <- as(st_geometry(sf_row), 'Spatial')
    sp_row <- spTransform(sp_row, crs(raster_obj))
    crp <- crop(raster_obj, sp_row)
    msk <- mask(crp, sp_row)
   
    if (exists("out_ls") == F) out_ls <- list()
    out_ls[sf_row$GEOID] <- msk
  }
  out_ls
}
raster_2017 <- raster("../data/lodes/raster/CDL_2017_41065.tif")
sf <- tracts("OR", "Wasco County")
x <- crop_mask_raster_to_spatial(raster_2017, sf)
```









raster
```{r}
library(rgdal)
crs(raster_2017) <- sp::CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")
leaflet() %>% 
  addTiles() %>%
  addRasterImage(raster_2017)
```

takes forever to run (using 8 cores)

```{r}
rasterToPolygons(raster_2017)
```

