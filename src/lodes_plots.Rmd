---
title: "Lodes Plots"
author: "Owen Hart"
date: "7/15/2020"
output: html_document
---

```{r}
library(R.utils)
library(data.table)
library(tidyr)
library(dplyr)
library(readr)
library(ggplot2)
```

```{r}
lodes17 <- read_csv("../data/lodes/agg/jobs_all_2017.csv")

lodes16 <- read_csv("../data/lodes/agg/jobs_all_2016.csv")

lodes15 <- read_csv("../data/lodes/agg/jobs_all_2015.csv")




lodes17$h_state <- substr(lodes17$h_geocode_tract, 1, 2)
lodes17$h_county <- substr(lodes17$h_geocode_tract, 3, 5)
lodes17$h_tract <- substr(lodes17$h_geocode_tract, 6, 11)



lodes16$h_state <- substr(lodes16$h_geocode_tract, 1, 2)
lodes16$h_county <- substr(lodes16$h_geocode_tract, 3, 5)
lodes16$h_tract <- substr(lodes16$h_geocode_tract, 6, 11)


lodes15$h_state <- substr(lodes15$h_geocode_tract, 1, 2)
lodes15$h_county <- substr(lodes15$h_geocode_tract, 3, 5)
lodes15$h_tract <- substr(lodes15$h_geocode_tract, 6, 11)

#now work geoid


lodes17$w_state <- substr(lodes17$w_geocode_tract, 1, 2)
lodes17$w_county <- substr(lodes17$w_geocode_tract, 3, 5)
lodes17$w_tract <- substr(lodes17$w_geocode_tract, 6, 11)



lodes16$w_state <- substr(lodes16$w_geocode_tract, 1, 2)
lodes16$w_county <- substr(lodes16$w_geocode_tract, 3, 5)
lodes16$w_tract <- substr(lodes16$w_geocode_tract, 6, 11)


lodes15$w_state <- substr(lodes15$w_geocode_tract, 1, 2)
lodes15$w_county <- substr(lodes15$w_geocode_tract, 3, 5)
lodes15$w_tract <- substr(lodes15$w_geocode_tract, 6, 11)
```

Must load in Oregon XWalk csv
```{r}

#download.file(
#  url = "https://lehd.ces.census.gov/data/lodes/LODES7/or/or_xwalk.csv.gz", 
#  destfile = "../data/lodes/or_xwalk.csv.gz")
#gunzip("../data/lodes/or_xwalk.csv.gz")

or_xw <- read_csv("../data/lodes/or_xwalk.csv", col_types = cols(cty = col_character()))
```
What % of jobs flow from outside of Fairfax County?
```{r}
bool_cond17 <-lodes17$h_county != "065" & lodes17$w_county == "065"

bool_cond16 <-lodes16$h_county != "065" & lodes16$w_county == "065"

bool_cond15 <-lodes15$h_county != "065" & lodes15$w_county == "065"


flows_in_17 <-lodes17[bool_cond17, ]
flows_in_16 <-lodes16[bool_cond16, ]
flows_in_15 <-lodes15[bool_cond15, ]


pie(c(mean(bool_cond17) * 100, (1 - mean(bool_cond17)) * 100), labels = c("% Jobs in Wasco County\n flowing from outside (2017)", "% Jobs in Wasco County\n flowing from within (2017)"))

pie(c(mean(bool_cond16) * 100, (1 - mean(bool_cond16)) * 100), labels = c("% Jobs in Wasco County\n flowing from outside (2016)", "% Jobs in Wasco County\n flowing from within (2016)"))

pie(c(mean(bool_cond15) * 100, (1 - mean(bool_cond15)) * 100), labels = c("% Jobs in Wasco County\n flowing from outside (2015)", "% Jobs in Wasco County\n flowing from within (2015)"))
```


Of the flows into Wasco County from outside, what percent are from other counties in Oregon?
```{r}
#2017
perc_flows_othercnt_2017 <- mean(flows_in_17$h_state == "41") *100
perc_flows_othercnt_2017

agg_cnty_OR_2017 <- flows_in_17[flows_in_17$h_state == "41", ] %>%
  group_by(h_county) %>%
  summarise(S000 = sum(S000))

#Use OR crosswalk to get county names
or_xw$h_county <- substring(or_xw$cty, 3, 6)
essential <- or_xw %>%
  select(h_county, ctyname)

agg_cnty_OR_with_names_2017 <- inner_join(x = agg_cnty_OR_2017, y = unique(essential), by = "h_county")

trimmed_2017 <- agg_cnty_OR_with_names_2017[order(-agg_cnty_OR_with_names_2017$S000), ][1:10, ]
ggplot(trimmed_2017, aes(ctyname, S000)) + geom_col() + coord_flip() + ggtitle("Number of Jobs flowing into Wasco County\n from other counties in Oregon (2017)")



#2016
perc_flows_othercnt_2016 <- mean(flows_in_16$h_state == "41") *100
perc_flows_othercnt_2016

agg_cnty_OR_2016 <- flows_in_16[flows_in_16$h_state == "41", ] %>%
  group_by(h_county) %>%
  summarise(S000 = sum(S000))

#Use OR crosswalk to get county names
or_xw$h_county <- substring(or_xw$cty, 3, 6)
essential <- or_xw %>%
  select(h_county, ctyname)

agg_cnty_OR_with_names_2016 <- inner_join(x = agg_cnty_OR_2016, y = unique(essential), by = "h_county")


trimmed_2016 <- agg_cnty_OR_with_names_2016[order(-agg_cnty_OR_with_names_2016$S000), ][1:10, ]
ggplot(trimmed_2016, aes(ctyname, S000)) + geom_col() + coord_flip() + ggtitle("Number of Jobs flowing into Wasco County\n from other counties in Oregon (2016)")


#2015
perc_flows_othercnt_2015 <- mean(flows_in_15$h_state == "41") *100
perc_flows_othercnt_2015

agg_cnty_OR_2015 <- flows_in_15[flows_in_15$h_state == "41", ] %>%
  group_by(h_county) %>%
  summarise(S000 = sum(S000))

#Use OR crosswalk to get county names
or_xw$h_county <- substring(or_xw$cty, 3, 6)
essential <- or_xw %>%
  select(h_county, ctyname)

agg_cnty_OR_with_names_2015 <- inner_join(x = agg_cnty_OR_2015, y = unique(essential), by = "h_county")


trimmed_2015 <- agg_cnty_OR_with_names_2015[order(-agg_cnty_OR_with_names_2015$S000), ][1:10, ]
ggplot(trimmed_2015, aes(ctyname, S000)) + geom_col() + coord_flip() + ggtitle("Number of Jobs flowing into Wasco County\n from other counties in Oregon (2015)")
```









Mapping S. Wasco
```{r}
library(tigris)

wasco_points <- (blocks("OR", county = "Wasco"))

wasco_county <- st_read("../data/shps/county")
south_wasco_points <- st_read("../data/shps/swsd")
wasco_lines <- data.frame(wasco_points)
```
```{r}
south_wasco_points <- st_read("../data/shps/swsd")
```

Reading in files
```{r}
main17 <- fread("../data/lodes/or_od_main_JT00_2017.csv", 
              colClasses = c("w_geocode" = "character",
                             "h_geocode" = "character"))

aux17 <- fread("../data/lodes/or_od_aux_JT00_2017.csv", 
              colClasses = c("w_geocode" = "character",
                             "h_geocode" = "character"))

full_data17 <- rbind(main17, aux17)


main16 <- fread("../data/lodes/or_od_main_JT00_2016.csv", 
              colClasses = c("w_geocode" = "character",
                             "h_geocode" = "character"))

aux16 <- fread("../data/lodes/or_od_aux_JT00_2016.csv", 
              colClasses = c("w_geocode" = "character",
                             "h_geocode" = "character"))

full_data16 <- rbind(main16, aux16)


main15 <- fread("../data/lodes/or_od_main_JT00_2015.csv", 
              colClasses = c("w_geocode" = "character",
                             "h_geocode" = "character"))

aux15 <- fread("../data/lodes/or_od_aux_JT00_2015.csv", 
              colClasses = c("w_geocode" = "character",
                             "h_geocode" = "character"))

full_data15 <- rbind(main15, aux15)
```

Filtering so that it only includes Wasco County (need to address S. Wasco part)
```{r}
wasco17 <- full_data17 %>% 
  filter(w_geocode %in% full_data17$w_geocode[substr(full_data17$w_geocode, 1, 5) == "41065"]|h_geocode %in% full_data17$h_geocode[substr(full_data17$h_geocode, 1, 5) == "41065"])


wasco16 <- full_data16 %>% 
  filter(w_geocode %in% full_data16$w_geocode[substr(full_data16$w_geocode, 1, 5) == "41065"]|h_geocode %in% full_data16$h_geocode[substr(full_data16$h_geocode, 1, 5) == "41065"])

wasco15 <- full_data15 %>% 
  filter(w_geocode %in% full_data15$w_geocode[substr(full_data15$w_geocode, 1, 5) == "41065"]|h_geocode %in% full_data15$h_geocode[substr(full_data15$h_geocode, 1, 5) == "41065"])
```

Joining with Wasco Lines
```{r}
wascolines_17 <- inner_join(wasco17, wasco_lines, by = c("w_geocode" = "GEOID10"))
wascolines_16 <- inner_join(wasco16, wasco_lines, by = c("w_geocode" = "GEOID10"))
wascolines_15 <- inner_join(wasco15, wasco_lines, by = c("w_geocode" = "GEOID10"))
wascolines_17
```


Grouping by work geocode (because that is going to be Wasco County)
```{r}
agg_17 <- wascolines_17 %>%
  group_by(w_geocode, INTPTLAT10, INTPTLON10, geometry) %>%
  summarise(S000 = sum(S000), 
            SA01 = sum(SA01), 
            SA02 = sum(SA02), 
            SA03 = sum(SA03), 
            SE01 = sum(SE01), 
            SE02 = sum(SE02), 
            SE03 = sum(SE03), 
            SI01 = sum(SI01), 
            SI02 = sum(SI02), 
            SI03 = sum(SI03))

agg_16 <- wascolines_16 %>%
  group_by(w_geocode, INTPTLAT10, INTPTLON10, geometry) %>%
  summarise(S000 = sum(S000), 
            SA01 = sum(SA01), 
            SA02 = sum(SA02), 
            SA03 = sum(SA03), 
            SE01 = sum(SE01), 
            SE02 = sum(SE02), 
            SE03 = sum(SE03), 
            SI01 = sum(SI01), 
            SI02 = sum(SI02), 
            SI03 = sum(SI03))

agg_15 <- wascolines_15 %>%
  group_by(w_geocode, INTPTLAT10, INTPTLON10, geometry) %>%
  summarise(S000 = sum(S000), 
            SA01 = sum(SA01), 
            SA02 = sum(SA02), 
            SA03 = sum(SA03), 
            SE01 = sum(SE01), 
            SE02 = sum(SE02), 
            SE03 = sum(SE03), 
            SI01 = sum(SI01), 
            SI02 = sum(SI02), 
            SI03 = sum(SI03))
```


maps
```{r}
alljobs_2017 <- ggplot(wasco_county) +
  geom_sf() +
  geom_sf(data = south_wasco_points, color = "red") +
  geom_sf(data=agg_17[agg_17$S000 < 600, ], aes(fill=S000, geometry = geometry)) + #got rid of 1 outliar of 774
  ggtitle("Total number of jobs in South Wasco County\n by Census Block in 2017") +
  scale_fill_continuous_tableau(name = "Number of Jobs")
alljobs_2017

goodsjobs_2017 <- ggplot(wasco_county) +
  geom_sf() +
  geom_sf(data = south_wasco_points, color = "red") +
  geom_sf(data=agg_17, aes(fill=SI01, geometry = geometry)) + 
  ggtitle("Total number of jobs in Goods Producing industry sectors\n in South Wasco County by Census Block in 2017") +
  scale_fill_continuous_tableau(name = "Number of Jobs")
goodsjobs_2017


utilsjobs_2017 <- ggplot(wasco_county) +
  geom_sf() +
  geom_sf(data = south_wasco_points, color = "red") +
  geom_sf(data=agg_17, aes(fill=SI02, geometry = geometry)) + 
  ggtitle("Total number of jobs in Trade, Transportation,\n and Utilities industry sectors\n in South Wasco County by Census Block in 2017") +
  scale_fill_continuous_tableau(name = "Number of Jobs")
utilsjobs_2017
  
servicejobs_2017 <- ggplot(wasco_county) +
  geom_sf() +
  geom_sf(data = south_wasco_points, color = "red") +
  geom_sf(data=agg_17[agg_17$SI03 < 600, ], aes(fill=SI03, geometry = geometry)) +  # 1 outliar
  ggtitle("Total number of jobs in All Other Services industry sectors\n in South Wasco County by Census Block in 2017") +
  scale_fill_continuous_tableau(name = "Number of Jobs")
servicejobs_2017
```

2016 maps
```{r}
alljobs_2016 <- ggplot(wasco_county) +
  geom_sf() +
  geom_sf(data = south_wasco_points, color = "red") +
  geom_sf(data=agg_16[agg_16$S000 < 600, ], aes(fill=S000, geometry = geometry)) + #got rid of 1 outliar of 774
  ggtitle("Total number of jobs in South Wasco County\n by Census Block in 2016") +
  scale_fill_continuous_tableau(name = "Number of Jobs")
alljobs_2016

goodsjobs_2016 <- ggplot(wasco_county) +
  geom_sf() +
  geom_sf(data = south_wasco_points, color = "red") +
  geom_sf(data=agg_16, aes(fill=SI01, geometry = geometry)) + 
  ggtitle("Total number of jobs in Goods Producing industry sectors\n in South Wasco County by Census Block in 2016") +
  scale_fill_continuous_tableau(name = "Number of Jobs")
goodsjobs_2016


utilsjobs_2016 <- ggplot(wasco_county) +
  geom_sf() +
  geom_sf(data = south_wasco_points, color = "red") +
  geom_sf(data=agg_16, aes(fill=SI02, geometry = geometry)) + 
  ggtitle("Total number of jobs in Trade, Transportation,\n and Utilities industry sectors\n in South Wasco County by Census Block in 2016") +
  scale_fill_continuous_tableau(name = "Number of Jobs")
utilsjobs_2016
  
servicejobs_2016 <- ggplot(wasco_county) +
  geom_sf() +
  geom_sf(data = south_wasco_points, color = "red") +
  geom_sf(data=agg_16[agg_16$SI03 < 600, ], aes(fill=SI03, geometry = geometry)) +  # 1 outliar
  ggtitle("Total number of jobs in All Other Services industry sectors\n in South Wasco County by Census Block in 2016") +
  scale_fill_continuous_tableau(name = "Number of Jobs")
servicejobs_2016
```

2015 maps
```{r}
alljobs_2015 <- ggplot(wasco_county) +
  geom_sf() +
  geom_sf(data = south_wasco_points, color = "red") +
  geom_sf(data=agg_15[agg_15$S000 < 600, ], aes(fill=S000, geometry = geometry)) + #got rid of 1 outliar of 774
  ggtitle("Total number of jobs in South Wasco County\n by Census Block in 2015") +
  scale_fill_continuous_tableau(name = "Number of Jobs")
alljobs_2015

goodsjobs_2015 <- ggplot(wasco_county) +
  geom_sf() +
  geom_sf(data = south_wasco_points, color = "red") +
  geom_sf(data=agg_15, aes(fill=SI01, geometry = geometry)) + 
  ggtitle("Total number of jobs in Goods Producing industry sectors\n in South Wasco County by Census Block in 2015") +
  scale_fill_continuous_tableau(name = "Number of Jobs")
goodsjobs_2015


utilsjobs_2015 <- ggplot(wasco_county) +
  geom_sf() +
  geom_sf(data = south_wasco_points, color = "red") +
  geom_sf(data=agg_15, aes(fill=SI02, geometry = geometry)) + 
  ggtitle("Total number of jobs in Trade, Transportation,\n and Utilities industry sectors\n in South Wasco County by Census Block in 2015") +
  scale_fill_continuous_tableau(name = "Number of Jobs")
utilsjobs_2015
  
servicejobs_2015 <- ggplot(wasco_county) +
  geom_sf() +
  geom_sf(data = south_wasco_points, color = "red") +
  geom_sf(data=agg_15[agg_15$SI03 < 600, ], aes(fill=SI03, geometry = geometry)) +  # 1 outliar
  ggtitle("Total number of jobs in All Other Services industry sectors\n in South Wasco County by Census Block in 2015") +
  scale_fill_continuous_tableau(name = "Number of Jobs")
servicejobs_2015
```
